name: Deploy Leptos CSR to GitHub Pages

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust Nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt
          
      - name: Add WASM target
        run: rustup target add wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Trunk
        run: |
          wget -qO- https://github.com/trunk-rs/trunk/releases/download/v0.21.4/trunk-x86_64-unknown-linux-gnu.tar.gz | tar -xzf-
          chmod +x trunk
          ./trunk --version

      - name: Verify Cargo Configuration
        run: |
          echo "=== Cargo.toml contents ==="
          cat Cargo.toml
          echo "=== Checking for target conflicts ==="
          cargo metadata --format-version 1 | grep -E '"name"|"crate_types"' || true

      - name: Build with Trunk
        run: |
          # For GitHub Pages project repos, use the repository name as base path
          if [[ "${{ github.event.repository.name }}" == *".github.io" ]]; then
            echo "Building for user/org GitHub Pages (root domain)"
            ./trunk build --release
          else
            echo "Building for project GitHub Pages with base path: /${{ github.event.repository.name }}"
            ./trunk build --release --public-url "/${{ github.event.repository.name }}/"
          fi

      - name: Verify Build Output
        run: |
          echo "=== Build output structure ==="
          find ./dist -type f -name "*.wasm" -o -name "*.js" -o -name "*.html" | head -10
          echo "=== dist/ directory contents ==="
          ls -la ./dist/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
